---
- name: Install zsh (Linux)
  ansible.builtin.apt:
    name: zsh
    state: present
  become: true
  when: is_linux

- name: Copy .zshrc
  ansible.builtin.copy:
    src: .zshrc
    dest: "{{ ansible_facts['env']['HOME'] }}/.zshrc"
    mode: "0644"
    backup: true

- name: Copy .aliases
  ansible.builtin.copy:
    src: .aliases
    dest: "{{ ansible_facts['env']['HOME'] }}/.aliases"
    mode: "0644"

- name: Copy platform-specific aliases
  ansible.builtin.copy:
    src: "{{ aliases_platform_file }}"
    dest: "{{ ansible_facts['env']['HOME'] }}/.aliases_platform"
    mode: "0644"
  vars:
    aliases_platform_file: >-
      {%- if 'wsl' in group_names -%}.aliases_wsl
      {%- elif is_macos | bool -%}.aliases_macos
      {%- else -%}.aliases_linux
      {%- endif -%}

- name: Deploy .zshrc_extra from template
  ansible.builtin.template:
    src: .zshrc_extra.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.zshrc_extra"
    mode: "0644"

- name: Ensure zsh plugins directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.zsh/plugins"
    state: directory
    mode: "0755"

- name: Clone zsh plugins
  ansible.builtin.git:
    repo: "https://github.com/{{ item.repo }}.git"
    dest: "{{ ansible_facts['env']['HOME'] }}/.zsh/plugins/{{ item.name }}"
    depth: 1
  loop:
    - { repo: zsh-users/zsh-syntax-highlighting, name: zsh-syntax-highlighting }
    - { repo: zsh-users/zsh-autosuggestions, name: zsh-autosuggestions }
    - { repo: zsh-users/zsh-completions, name: zsh-completions }
  loop_control:
    label: "{{ item.name }}"

- name: Ensure starship config directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config"
    state: directory
    mode: "0755"

- name: Copy starship.toml
  ansible.builtin.copy:
    src: starship.toml
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/starship.toml"
    mode: "0644"
    backup: true

- name: Ensure ~/.local/bin exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.local/bin"
    state: directory
    mode: "0755"
  when: is_linux

- name: Install Starship (Linux)
  ansible.builtin.shell: curl -sS https://starship.rs/install.sh | sh -s -- -y -b ~/.local/bin
  args:
    creates: "{{ ansible_facts['env']['HOME'] }}/.local/bin/starship"
  when: is_linux

- name: Get path to zsh
  ansible.builtin.command: which zsh
  register: zsh_path
  changed_when: false

- name: Ensure zsh is in /etc/shells
  ansible.builtin.lineinfile:
    path: /etc/shells
    line: "{{ zsh_path.stdout }}"
    state: present
  become: true

- name: Set zsh as default shell
  ansible.builtin.user:
    name: "{{ ansible_facts['env']['USER'] }}"
    shell: "{{ zsh_path.stdout }}"
  become: true
