---
- name: Check if Homebrew is installed
  ansible.builtin.command: which brew
  register: brew_check
  changed_when: false
  failed_when: false

- name: Install Homebrew
  ansible.builtin.shell: >
    NONINTERACTIVE=1 /bin/bash -c
    "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  when: brew_check.rc != 0

- name: Add Homebrew to PATH (Apple Silicon)
  ansible.builtin.shell: eval "$(/opt/homebrew/bin/brew shellenv)"
  when:
    - brew_check.rc != 0
    - ansible_facts['architecture'] == 'arm64'
  changed_when: false

- name: Remove deprecated taps
  ansible.builtin.command: brew untap {{ item }}
  loop:
    - homebrew/cask-versions
    - homebrew/cask-fonts
  register: untap_result
  changed_when: untap_result.rc == 0
  failed_when: false

- name: Update Homebrew
  community.general.homebrew:
    update_homebrew: true

- name: Install common packages via Brewfile
  ansible.builtin.command:
    cmd: brew bundle --file={{ dotfiles_dir }}/roles/macos/homebrew/files/Brewfile.common
  changed_when: false

- name: Cache sudo credentials for cask installs
  ansible.builtin.command: sudo -v
  become: true
  changed_when: false
  when: homebrew_install_private

- name: Install private packages via Brewfile
  ansible.builtin.command:
    cmd: brew bundle --file={{ dotfiles_dir }}/roles/macos/homebrew/files/Brewfile.private
  when: homebrew_install_private
  changed_when: false
