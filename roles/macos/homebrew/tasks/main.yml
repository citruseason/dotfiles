---
- name: Check if Homebrew is installed
  ansible.builtin.command: which brew
  register: brew_check
  changed_when: false
  failed_when: false

- name: Install Homebrew
  ansible.builtin.shell: >
    NONINTERACTIVE=1 /bin/bash -c
    "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  when: brew_check.rc != 0

- name: Add Homebrew to PATH (Apple Silicon)
  ansible.builtin.shell: eval "$(/opt/homebrew/bin/brew shellenv)"
  when:
    - brew_check.rc != 0
    - ansible_facts['architecture'] == 'arm64'
  changed_when: false

- name: Remove deprecated taps
  ansible.builtin.command: brew untap {{ item }}
  loop:
    - homebrew/cask-versions
    - homebrew/cask-fonts
  register: untap_result
  changed_when: untap_result.rc == 0
  failed_when: false

- name: Update Homebrew
  community.general.homebrew:
    update_homebrew: true

- name: Install formulae
  community.general.homebrew:
    name: "{{ homebrew_formulae }}"
    state: present

- name: Write sudo password file
  ansible.builtin.copy:
    content: "{{ sudo_password }}"
    dest: /tmp/.ansible_sudo_pass
    mode: "0600"
  no_log: true
  changed_when: false

- name: Create sudo askpass helper
  ansible.builtin.copy:
    content: |
      #!/bin/sh
      cat /tmp/.ansible_sudo_pass
    dest: /tmp/.ansible_askpass
    mode: "0700"
  changed_when: false

- name: Install casks
  community.general.homebrew_cask:
    name: "{{ homebrew_casks }}"
    state: present
    install_options: adopt
  environment:
    SUDO_ASKPASS: /tmp/.ansible_askpass

- name: Install private casks
  community.general.homebrew_cask:
    name: "{{ homebrew_private_casks }}"
    state: present
    install_options: adopt
  environment:
    SUDO_ASKPASS: /tmp/.ansible_askpass
  when: homebrew_install_private

- name: Remove sudo askpass files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/.ansible_askpass
    - /tmp/.ansible_sudo_pass

- name: Install Mac App Store apps
  community.general.mas:
    id: "{{ item.id }}"
    state: present
  loop: "{{ homebrew_mas_apps }}"
  loop_control:
    label: "{{ item.name }}"
  when: homebrew_install_private
